<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="css/cursor.css" type="text/css" rel="stylesheet">
    <script src="jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="cursor.js"></script>
    <script type="text/javascript" charset="utf-8" src="text.js"></script>
</head>
<body>
<div id="container" style="padding:10px;word-wrap:break-word;width:900px;border:1px solid #ccc">
    <div>
        <div>
            <span>sdfsdf战役战役首都发生地sdfsdfsdfsdfs</span>
        </div>
        <div>
            <span>sdfsdfsdfsdfsdfsdfs</span>
        </div>
        <div style="width:900px;">
            <span>sdfsdfsdfs</span><img src="http://www.baidu.com/img/bdlogo.gif" /><span>dfsdfsdfs</span>
        </div>
    </div>
</div>

<script type="text/javascript">
    var cursor = new Cursor(document);
      cursor.appendTo($('#container'))
    function getLineNodes(parent,y){
        function checkY(node,y){
            var top = $(node).offset().top,
                    bottom = $(node).height() + top;
            if(top <= y && y <= bottom){
                return true
            }
        }
        function mergesibling(n){
            var pre = n.previousSibling;
            if(pre && pre.nodeType == 3){
                pre.nodeValue += n.nodeValue;
                n.parentNode.removeChild(n);
                var next = pre.nextSibling;
                if(next && next.nodeType == 3){
                    pre.nodeValue += next.nodeValue;
                    next.parentNode.removeChild(next)
                }
            }
            if(n.parentNode){
                next = n.nextSibling;
                if(next && next.nodeType == 3){
                    n.nodeValue += next.nodeValue;
                    next.parentNode.removeChild(next)
                }
            }
        }
        var nodes = [];
        var childs = [];
        $.each(parent.childNodes,function(i,n){
            childs.push(n)
        });
        $.each(childs,function(i,n){
            cursor.remove();
            if(n.nodeType == 3){
                n.splitText(1);
                var $tmp = $('<span></span>').insertBefore(n).append(n);
                if($tmp.width() == 0){
                    $tmp[0].parentNode.insertBefore(n,$tmp[0]);
                    $tmp.remove();

                }

                if($tmp.offset().top + $tmp.height() >= y){

                }
                var $tmp = $('<span></span>').insertBefore(n).append(n);
                if(checkY($tmp,y)){




                    cursor.insertBefore($tmp.first());

                    if(cursor.top() + cursor.height() >= y){
                        nodes.push(n);
                    }
                    while(cursor.top() + cursor.height() < y){
                         n = n.splitText(1);
                        cursor.insertBefore(n);
                        if(cursor.top() + cursor.height() >= y){
                            nodes.push(n);
                            break;
                        }
                        var prev = cursor.prev();
                        if(prev && prev.previousSibling && prev.previousSibling.nodeType == 3){
                            prev.nodeValue += prev.previousSibling.nodeValue;
                            prev.parentNode.removeChild(prev);
                        }


                    }
                }

                $tmp.remove();


            }else{
                checkY(n,y) && nodes.push(n)
            }

        })

        return nodes;
    }
    $('div').mousedown(function(e){

        cursor.hide()
        var target = e.target;
        if(target.tagName == 'DIV'){
            $(target).children().each(function(i,span){

               if(span.tagName == 'SPAN'){
                   var data = $(span).data('text');

                   if(!data){
                       data = new Text($(span))
                       $(span).data('text',data)
                   }
                   var x = e.pageX;
                   var flag = false;
                   $.each(data.data,function(i,d){
                       if(x >= d.left && x <= d.left + d.width  ){
                           if(x - d.left > d.width/2){
                               //right
                               cursor.offset({
                                   top : d.top,
                                   left : d.left + d.width
                               })
                           }else{
                               cursor.offset({
                                   top : d.top,
                                   left : d.left
                               })
                           }
                           cursor.show();
                           flag = true;
                           return false;
                       }
                   })
                   if(flag){
                       return false;
                   }
               }

            })
        }else{
            var data = $(target).data('text');

            if(!data){
                data = new Text($(target))
                $(target).data('text',data)
            }
            var x = e.pageX;
            $.each(data.data,function(i,d){
                if(x >= d.left && x <= d.left + d.width  ){
                    if(x - d.left > d.width/2){
                        //right
                        cursor.offset({
                            top : d.top,
                            left : d.left + d.width
                        })
                    }else{
                        cursor.offset({
                            top : d.top,
                            left : d.left
                        })
                    }
                    cursor.show();
                    return false;
                }
            })
        }


    })

</script>
</body>
</html>